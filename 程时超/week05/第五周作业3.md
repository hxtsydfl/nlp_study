# RAG实现流程

## 1.文档处理

### 文档内容提取(`_extract_pdf_content`)

- 使用 `pdfplumber` 提取 PDF 的前 3 页内容
- 对每一页内容：
  - 提取文本
  - 生成嵌入向量
  - 使用重叠策略进行文本分割成更小的块
  - 对每个块生成嵌入并存储

### 提取入口(`extract_content`)

- 对pdf文件进行提取

## 2.嵌入和重排序

### 获取嵌入 (`get_embedding`)

- 使用预加载的嵌入模型对文本进行编码
- 支持bge系列的中文嵌入模型

### 重排序 (`get_rank`)

- 对查询-文档对进行匹配打分
- 使用bge重排序模型

## 3.检索和对话

### 文档检索 (`query_document`)

- **全文检索**：指定一个知识库检索，bm25打分
- **语义检索**：使用KNN进行检索
- **结果融合**：使用 RRF合并两种检索结果
- **重排序**：对合并后的结果进行重排序

### RAG 对话 (`chat_with_rag`)

- 处理用户查询
- 检索相关文档
- 构建提示词模板，将检索到的文档作为上下文
- 调用 LLM 生成回答

### 聊天 (`chat`)

- 使用glm-4-air进行聊天对话

---

### 流程总览

**文档处理：**

读取PDF文档 →文本提取→文本分块处理→文本向量编码→存入Elasticsearch

**问答：**

用户提问→双路检索(BM25+向量)→RRF融合→重排序→ 提取相关片段→LLM生成→返回答案

